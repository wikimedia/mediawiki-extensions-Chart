Phabricator [T383613](https://phabricator.wikimedia.org/T383613)

Status: Accepted

Date: January 3, 2025
Modified: June 4, 2025

# Problem statement

After the implementation of [ADR 5 (Client side rendering)](./0005.%20Client%20side%20rendering.md),
we encountered two problems:
- The number of data attributes on the `<mw-chart>` element proliferated rapidly: we started with
  one attribute (`data-spec`), but after two months we were up to 4 attributes: `data-spec`,
  `data-theme`, `data-x-axis-type` and `data-y-axis-type`.
- The attributes with complex values (`data-spec` and `data-theme`) were represented as URL-encoded
  JSON. This was the wrong choice for escaping (HTML attribute escaping should have been used
  instead) and is also wasteful, bloating the output size since JSON contains many special
  characters that are encoded by URL encoding.

Adding or removing data attributes or changing their format is non-trivial, because the client-side
code may be run on cached HTML that was generated by older server-side code and uses an older
format. Such a scenario will cause errors unless explicit efforts are made to make the client-side
code backwards compatible.

# Decision outcome

We decided to consolidate all the data attributes into one `data-mw-chart` attribute, which contains
a JSON blob whose keys are the previous data attribute names:
```json
{
	"spec": { ... },
	"theme": { ... },
	"xAxisType": "...",
	"yAxisType": "..."
}
```
There is a `ChartData` interface in `render.ts` in the `chart-renderer` repo that specifies this
format, which we will update as the format evolves.

This new data attribute is not URL-encoded. For security and correctness, special characters
in the JSON blob are escaped using HTML attribute escaping (`data-mw-chart="{&quot;spec&quot;{...}}"`),
but this is transparent to the client-side JavaScript code, which no longer has to do its own
decoding.

For backward compatibility, the client-side code was updated to handle both the old and the new
format; we'll be able to remove support for the old format once the new format has been deployed
for long enough that content with the old format has expired from the cache. To detect which format
is being used, the client-side code looks at whether the `data-mw-chart` attribute is present.

Originally we used data-chart, but switched to data-mw-chart for better Parsoid support.

# Decision drivers

- We want the data attribute format to be simple and easy to understand.
- The data attribute value must be escaped correctly for security, but without unnecessary
  escaping that bloats its size.
- Writing backwards compatible client-side code must be feasible. This means the client-side code
  must be able to easily detect which version of the format it's dealing with.


# Other options considered

We considered removing the URL-encoding from the `data-spec` and `data-theme` attributes without
making any other changes, but that would have made it more difficult to distinguish the old and
new formats. It also would not have addressed the data attribute proliferation issue.

